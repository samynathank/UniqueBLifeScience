@model IEnumerable<UniqueBLifeScience.Models.Sales>

@{
    ViewData["Title"] = "Sales";
}

<h1>Sales</h1>
<div class="row mb-2">
    <div class="col-md-3">
        <input type="date" id="startDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
    </div>
    <div class="col-md-3">
        <input type="date" id="endDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
    </div>
    <div class="col-md-3">
        <button id="filterButton" class="btn btn-info btn-sm">Filter</button>
    </div>
    <div class="col-md-3 text-end">
        <a href="@Url.Action("CreateSales", "Home")" class="btn btn-success btn-sm">Add</a>
    </div>
</div>

<div class="table-responsive">
    <table id="salesTable" class="table">
        <thead>
            <tr>
                <th>Customer Name</th>
                <th>GST Number</th>
                <th>Phone Number</th>
                <th>DL Number</th>
                <th>Sales GST</th>
                <th>Discount</th>
                <th>Total</th>
                <th>Sales Bill</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                var salesGST = (double?)Math.Round((decimal)item.SalesGST, 2);
                var discountAmount = (double?)Math.Round((decimal)(item.Total * (item.Discount / 100.0)), 2);
                discountAmount = item.Total-discountAmount;
                <tr>
                    <td>@item.CustomerName</td>
                    <td>@item.GSTNumber</td>
                    <td>@item.PhoneNumber</td>
                    <td>@item.DLNumber</td>
                    <td>@salesGST</td>
                    <td>@item.Discount</td>
                    @if(item.Discount == 0)
                    {
                        <td>@item.Total</td>
                    }
                    @if(item.Discount != 0)
                    {
                        <td>@discountAmount</td>
                    }
                    <td>
                        <a href="@Url.Action("PrintBill", "Home", new { id = item.SalesID })" class="btn btn-secondary btn-sm">Print Bill</a>
                    </td>
                    <td>
                        <a href="@Url.Action("EditSales", "Home", new { id = item.SalesID })" class="btn btn-primary btn-sm">Edit</a>
                        <a href="@Url.Action("DeleteSales", "Home", new { id = item.SalesID })" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this stock?');">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize the DataTable
            var table = $('#salesTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'excelHtml5'
                ],
                paging: true,
                searching: true,
                ordering: true,
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50]
            });

            // Filter button click event
            $('#filterButton').on('click', function () {
                var startDate = $('#startDate').val();
                var endDate = $('#endDate').val();

                $.ajax({
                    url: '@Url.Action("GetDataBasedOnRange", "Home")',
                    type: 'GET',
                    data: {
                        startDate: startDate,
                        endDate: endDate
                    },
                    success: function (data) {
                        console.log(data); // Check the structure of the returned data

                        // Clear the existing rows in the DataTable
                        table.clear();

                        // Add new rows to the DataTable
                        $.each(data, function (index, item) {
                            var salesGST = (item.salesGST != null) ? item.salesGST.toFixed(2) : '';
                            var discountAmount = 0;
                            if (item.discount == 0) {
                                discountAmount = item.total.toFixed(2);
                            }
                            else {
                                discountAmount = (item.discount != 0) ? (item.total - (item.total * (item.discount / 100.0))).toFixed(2) : item.total.toFixed(2);
                            }
                            // Add a new row to the DataTable
                            table.row.add([
                                item.customerName,
                                item.gstNumber,
                                item.phoneNumber,
                                item.dlNumber,
                                salesGST,
                                item.discount,
                                discountAmount,
                                '<a href="@Url.Action("PrintBill", "Home")/' + item.salesID + '" class="btn btn-secondary btn-sm">Print Bill</a>',
                                '<a href="@Url.Action("EditSales", "Home")/' + item.salesID + '" class="btn btn-primary btn-sm">Edit</a>' +
                                '<a href="@Url.Action("DeleteSales", "Home")/' + item.salesID + '" class="btn btn-danger btn-sm" onclick="return confirm(\'Are you sure you want to delete this stock?\');">Delete</a>'
                            ]);
                        });

                        // Redraw the DataTable to reflect the changes
                        table.draw();
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX Error: " + status + error);
                    }
                });
            });
        });
    </script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
}
